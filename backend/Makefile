SHELL := /usr/bin/env bash
export PYTHONUNBUFFERED=1

.PHONY: help
help:
	@echo "ðŸš€ Backend Development Commands"
	@echo ""
	@echo "ðŸ“¦ Setup & Dependencies:"
	@echo "  setup          - Complete development environment setup"
	@echo "  venv           - Install project deps with uv"
	@echo "  env            - Copy environment template and show setup instructions"
	@echo ""
	@echo "ðŸƒ Development Server:"
	@echo "  dev            - Start development server with hot reload"
	@echo "  run            - Start bot locally (polling)"
	@echo "  worker         - Start background worker"
	@echo "  all            - Start API server and worker together"
	@echo ""
	@echo "ðŸ§ª Testing & Quality:"
	@echo "  test           - Run all tests"
	@echo "  test-unit      - Run unit tests only"
	@echo "  test-integration - Run integration tests only"
	@echo "  test-contracts - Run API contract tests"
	@echo "  test-performance - Run performance tests"
	@echo "  test-watch     - Run tests in watch mode"
	@echo "  coverage       - Generate test coverage report"
	@echo ""
	@echo "ðŸ” Code Quality:"
	@echo "  lint           - Run ruff linter"
	@echo "  lint-fix       - Run ruff linter with auto-fix"
	@echo "  typecheck      - Run pyright type checker"
	@echo "  format         - Format code with ruff"
	@echo "  check          - Run all quality checks (lint + typecheck)"
	@echo "  precommit      - Run pre-commit on all files"
	@echo ""
	@echo "ðŸ—„ï¸ Database & Services:"
	@echo "  db-migrate     - Run database migrations"
	@echo ""
	@echo "ðŸ³ Docker & Compose:"
	@echo "  docker-build   - Build Docker image"
	@echo "  docker-dev     - Start development with Docker Compose"
	@echo "  docker-logs    - View Docker Compose logs"
	@echo "  docker-clean   - Clean up Docker containers and volumes"
	@echo ""
	@echo "ðŸ“Š Monitoring & Health:"
	@echo "  health         - Check all service health"
	@echo "  logs           - View application logs"
	@echo "  monitor        - Monitor application performance"
	@echo "  connectivity   - Test backend-frontend connectivity"
	@echo ""
	@echo "ðŸ“‹ Documentation & OpenAPI:"
	@echo "  docs           - Generate and serve API documentation"
	@echo "  openapi-export - Export OpenAPI spec to JSON from running app"
	@echo ""
	@echo "ðŸš€ Deployment:"
	@echo "  build          - Build for production"
	@echo "  deploy-staging - Deploy to staging (if applicable)"
	@echo "  deploy-prod    - Deploy to production"
	@echo ""
	@echo "ðŸ§¹ Cleanup:"
	@echo "  clean          - Clean up temporary files and caches"
	@echo "  clean-all      - Clean everything including dependencies"

# =============================================================================
# SETUP & DEPENDENCIES
# =============================================================================

.PHONY: setup
setup: venv env
	@echo "âœ… Development environment setup complete!"
	@echo ""
	@echo "Next steps:"
	@echo "1. Update .env file with your credentials"
	@echo "2. Set DATABASE_URL in .env to your Neon connection string"
	@echo "3. Run 'make dev' to start the development server"
	@echo "4. Run 'make test' to verify everything is working"

.PHONY: venv
venv:
	@echo "ðŸ“¦ Installing dependencies with uv..."
	uv sync --all-extras

.PHONY: env
env:
	@if [ ! -f .env ]; then \
		echo "ðŸ“‹ Creating .env file from template..."; \
		cp env.template .env; \
		echo "âœ… .env file created!"; \
		echo ""; \
		echo "ðŸ”§ Please update .env with your credentials:"; \
		echo "   - TELEGRAM_BOT_TOKEN (get from @BotFather)"; \
		echo "   - OPENAI_API_KEY (get from OpenAI)"; \
		echo "   - Configure database and Redis URLs"; \
		echo ""; \
		echo "ðŸ“– See env.template for detailed setup instructions"; \
	else \
		echo "âœ… .env file already exists"; \
	fi

# =============================================================================
# DEVELOPMENT SERVER
# =============================================================================

.PHONY: dev
dev: venv
	@echo "ðŸš€ Starting development server..."
	@if [ -f .env ]; then \
		uv run dotenv run uvicorn calorie_track_ai_bot.main:app --host 0.0.0.0 --port 8000 --reload; \
	else \
		echo "âš ï¸  Warning: .env file not found. Using system environment variables only."; \
		uv run uvicorn calorie_track_ai_bot.main:app --host 0.0.0.0 --port 8000 --reload; \
	fi

.PHONY: run
run: dev

.PHONY: worker
worker: venv
	@echo "ðŸ”„ Starting background worker..."
	@if [ -f .env ]; then \
		uv run dotenv run python -m calorie_track_ai_bot.workers.estimate_worker; \
	else \
		echo "âš ï¸  Warning: .env file not found. Using system environment variables only."; \
		uv run python -m calorie_track_ai_bot.workers.estimate_worker; \
	fi

.PHONY: all
all:
	@echo "ðŸš€ Starting API server and worker..."
	@echo "Press Ctrl+C to stop all services"
	@trap 'kill %1 %2 2>/dev/null; exit' INT; \
	make dev & \
	sleep 3 && \
	make worker & \
	wait

# =============================================================================
# TESTING & QUALITY
# =============================================================================

.PHONY: test
test: venv
	@echo "ðŸ§ª Running all tests..."
	uv run pytest -v

.PHONY: test-unit
test-unit: venv
	@echo "ðŸ§ª Running unit tests..."
	uv run pytest tests/ -v --ignore=tests/integration/

.PHONY: test-integration
test-integration: venv
	@echo "ðŸ§ª Running integration tests..."
	uv run pytest tests/integration/ -v

.PHONY: test-contracts
test-contracts: venv
	@echo "ðŸ§ª Running API contract tests..."
	uv run pytest tests/api/ -v

.PHONY: test-performance
test-performance: venv
	@echo "ðŸ§ª Running performance tests..."
	uv run pytest tests/performance/ -v

.PHONY: test-watch
test-watch: venv
	@echo "ðŸ§ª Running tests in watch mode..."
	uv run pytest-watch --runner "pytest -v"

.PHONY: coverage
coverage: venv
	@echo "ðŸ“Š Generating test coverage report..."
	uv run pytest --cov=calorie_track_ai_bot --cov-report=html --cov-report=term
	@echo "ðŸ“‹ Coverage report generated in htmlcov/"

# =============================================================================
# CODE QUALITY
# =============================================================================

.PHONY: lint
lint: venv
	@echo "ðŸ” Running linter..."
	uv run ruff check

.PHONY: lint-fix
lint-fix: venv
	@echo "ðŸ”§ Running linter with auto-fix..."
	uv run ruff check --fix

.PHONY: typecheck
typecheck: venv
	@echo "ðŸ” Running type checker..."
	uv run pyright

.PHONY: format
format: venv
	@echo "âœ¨ Formatting code..."
	uv run ruff format

.PHONY: check
check: lint typecheck
	@echo "âœ… All quality checks passed!"

.PHONY: precommit
precommit: venv
	@echo "ðŸ”§ Setting up pre-commit hooks..."
	uv run pre-commit autoupdate
	uv run pre-commit install-hooks
	uv run pre-commit install --hook-type pre-commit --hook-type pre-push -f
	uv run pre-commit run --all-files

# =============================================================================
# DATABASE & SERVICES
# =============================================================================

.PHONY: db-migrate
db-migrate:
	@echo "ðŸ”„ Running database migrations against Neon..."
	@echo "Apply schema from infra/schema.sql via psql or Neon console"

# =============================================================================
# DOCKER & COMPOSE
# =============================================================================

.PHONY: docker-build
docker-build:
	@echo "ðŸ³ Building Docker image..."
	docker build -t calorie-track-api .

.PHONY: docker-dev
docker-dev:
	@echo "ðŸ³ Starting development with Docker Compose..."
	cd .. && docker-compose up --build

.PHONY: docker-logs
docker-logs:
	@echo "ðŸ“‹ Viewing Docker Compose logs..."
	cd .. && docker-compose logs -f

.PHONY: docker-clean
docker-clean:
	@echo "ðŸ§¹ Cleaning up Docker containers and volumes..."
	cd .. && docker-compose down -v
	docker image prune -f

# =============================================================================
# MONITORING & HEALTH
# =============================================================================

.PHONY: health
health:
	@echo "ðŸ¥ Checking service health..."
	@curl -f http://localhost:8000/health/live || echo "âŒ API server is down"
	@curl -f http://localhost:8000/health/connectivity || echo "âŒ Connectivity check failed"

.PHONY: logs
logs:
	@echo "ðŸ“‹ Viewing application logs..."
	@tail -f logs/*.log 2>/dev/null || echo "No log files found"

.PHONY: monitor
monitor:
	@echo "ðŸ“Š Monitoring application performance..."
	@echo "CPU and Memory usage:"
	@ps aux | grep "uvicorn\|estimate_worker" | grep -v grep

.PHONY: connectivity
connectivity:
	@echo "ðŸ”— Testing backend-frontend connectivity..."
	@curl -s http://localhost:8000/health/connectivity | python -m json.tool

# =============================================================================
# DOCUMENTATION & OPENAPI
# =============================================================================

.PHONY: docs
docs: venv
	@echo "ðŸ“š Starting API documentation server..."
	@echo "Visit http://localhost:8000/docs for Swagger UI"
	@echo "Visit http://localhost:8000/redoc for ReDoc"
	@echo "Press Ctrl+C to stop the server"
	@open http://localhost:8000/docs 2>/dev/null || true
	@uv run uvicorn src.calorie_track_ai_bot.main:app --host 0.0.0.0 --port 8000 --reload

.PHONY: openapi-export
openapi-export: venv
	@echo "ðŸ“„ Exporting OpenAPI spec from FastAPI app..."
	uv run python -c "import json; from calorie_track_ai_bot.main import app; print(json.dumps(app.openapi(), indent=2))" > openapi.json
	@echo "âœ… Exported to openapi.json"

# =============================================================================
# DEPLOYMENT
# =============================================================================

.PHONY: build
build: venv check test
	@echo "ðŸ—ï¸  Building for production..."
	@echo "âœ… All checks passed, ready for deployment!"

.PHONY: deploy-staging
deploy-staging:
	@echo "ðŸš€ Deploying to staging..."
	@echo "âš ï¸  Staging deployment not configured yet"

.PHONY: deploy-prod
deploy-prod:
	@echo "ðŸš€ Deploying to production..."
	@echo "âš ï¸  Production deployment not configured yet"

# =============================================================================
# CLEANUP
# =============================================================================

.PHONY: clean
clean:
	@echo "ðŸ§¹ Cleaning up temporary files and caches..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name ".coverage" -delete 2>/dev/null || true
	find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".mypy_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".ruff_cache" -exec rm -rf {} + 2>/dev/null || true

.PHONY: clean-all
clean-all: clean
	@echo "ðŸ§¹ Cleaning everything including dependencies..."
	rm -rf .venv/
	uv cache clean
